<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>增强版WebDAV视频播放器</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            margin: 0;
            background: #1a1a1a;
            color: #ffffff;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
            background: #2d2d2d;
            padding: 20px;
            border-radius: 8px;
        }
        .config-section {
            background: #2d2d2d;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #ccc;
        }
        .form-group input {
            width: 100%;
            padding: 10px;
            background: #1a1a1a;
            border: 1px solid #555;
            color: white;
            border-radius: 4px;
        }
        button {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover:not(:disabled) {
            background: #0056b3;
        }
        button:disabled {
            background: #555;
            cursor: not-allowed;
        }
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
        }
        .video-section {
            background: #2d2d2d;
            border-radius: 8px;
            overflow: hidden;
        }
        .video-container {
            position: relative;
            background: #000;
        }
        video {
            width: 100%;
            height: auto;
            display: block;
        }
        .video-controls {
            padding: 15px;
            background: #2d2d2d;
        }
        .progress-container {
            position: relative;
            height: 8px;
            background: #555;
            border-radius: 4px;
            margin: 10px 0;
            cursor: pointer;
            overflow: hidden;
        }
        .progress-buffer {
            position: absolute;
            height: 100%;
            background: #777;
            border-radius: 4px;
            transition: width 0.1s;
        }
        .progress-segments {
            position: absolute;
            height: 100%;
            width: 100%;
            top: 0;
            left: 0;
        }
        .progress-segment {
            position: absolute;
            height: 100%;
            background: #28a745;
            opacity: 0.6;
            border-radius: 1px;
        }
        .progress-downloading {
            position: absolute;
            height: 100%;
            background: #ffc107;
            opacity: 0.8;
            border-radius: 1px;
            animation: pulse 1s infinite;
        }
        .progress-bar {
            position: absolute;
            height: 100%;
            background: #007bff;
            border-radius: 4px;
            transition: width 0.1s;
            z-index: 10;
        }
        @keyframes pulse {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 0.4; }
        }
        .time-display {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #ccc;
            margin-top: 5px;
        }
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .panel {
            background: #2d2d2d;
            border-radius: 8px;
            overflow: hidden;
        }
        .panel-header {
            background: #3d3d3d;
            padding: 10px 15px;
            font-weight: 500;
            border-bottom: 1px solid #555;
        }
        .panel-content {
            padding: 15px;
        }
        .file-list {
            max-height: 300px;
            overflow-y: auto;
        }
        .file-item {
            padding: 8px 12px;
            margin-bottom: 4px;
            background: #1a1a1a;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .file-item:hover {
            background: #404040;
        }
        .file-item.active {
            background: #007bff;
        }
        .file-item.video {
            border-left: 3px solid #28a745;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        .stat-item {
            background: #1a1a1a;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
        }
        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #007bff;
        }
        .stat-label {
            font-size: 12px;
            color: #ccc;
            margin-top: 4px;
        }
        .log-container {
            background: #1a1a1a;
            height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            padding: 10px;
            border-radius: 4px;
        }
        .log-entry {
            margin-bottom: 4px;
            word-wrap: break-word;
        }
        .log-entry.info { color: #17a2b8; }
        .log-entry.success { color: #28a745; }
        .log-entry.warning { color: #ffc107; }
        .log-entry.error { color: #dc3545; }
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: #3d3d3d;
            border-radius: 0 0 8px 8px;
            font-size: 12px;
        }
        .loading {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid #555;
            border-top: 2px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .hidden { display: none !important; }
        
        /* 响应式设计 */
        @media (max-width: 1024px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎬 增强版WebDAV视频播放器</h1>
            <p>支持Range请求、智能缓存、实时监控</p>
        </div>

        <div class="config-section">
            <div class="form-row">
                <div class="form-group">
                    <label>服务器地址:</label>
                    <input type="text" id="serverUrl" value="http://localhost:8090" />
                </div>
                <div class="form-group">
                    <label>用户名:</label>
                    <input type="text" id="username" value="18867123055" />
                </div>
                <div class="form-group">
                    <label>密码:</label>
                    <input type="password" id="password" value="1x1v8bj1000dbj9o9s1ay9setkp4d8zg" />
                </div>
                <div class="form-group">
                    <label>路径:</label>
                    <input type="text" id="basePath" value="/小鲸鱼" />
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>预加载策略:</label>
                    <select id="preloadMode" style="width: 100%; padding: 10px; background: #1a1a1a; border: 1px solid #555; color: white; border-radius: 4px;">
                        <option value="auto">自动预缓冲 (推荐)</option>
                        <option value="metadata">仅元数据</option>
                        <option value="none">不预加载</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>缓冲大小:</label>
                    <select id="bufferSize" style="width: 100%; padding: 10px; background: #1a1a1a; border: 1px solid #555; color: white; border-radius: 4px;">
                        <option value="5">5MB (移动网络)</option>
                        <option value="10" selected>10MB (标准)</option>
                        <option value="20">20MB (高速网络)</option>
                        <option value="50">50MB (本地网络)</option>
                    </select>
                </div>
            </div>
            <button id="connectBtn">连接服务器</button>
            <button id="refreshBtn" class="hidden">刷新文件</button>
            <button id="statsBtn" class="hidden">查看统计</button>
        </div>

        <div class="main-layout">
            <div class="video-section">
                <div class="video-container">
                    <video id="videoPlayer" preload="auto" controls>
                        您的浏览器不支持视频播放
                    </video>
                </div>
                <div class="video-controls">
                    <div class="progress-container" id="progressContainer">
                        <div class="progress-buffer" id="progressBuffer"></div>
                        <div class="progress-segments" id="progressSegments"></div>
                        <div class="progress-bar" id="progressBar"></div>
                    </div>
                    <div class="time-display">
                        <span id="currentTime">00:00</span>
                        <span>缓冲: <span id="bufferStatus">0%</span></span>
                        <span>网速: <span id="networkSpeed">0 KB/s</span></span>
                        <span id="duration">00:00</span>
                    </div>
                </div>
                <div class="status-bar">
                    <span id="videoStatus">等待选择视频...</span>
                    <span id="downloadSpeed">0 KB/s</span>
                </div>
            </div>

            <div class="sidebar">
                <div class="panel">
                    <div class="panel-header">📊 实时统计</div>
                    <div class="panel-content">
                        <div class="stats-grid">
                            <div class="stat-item">
                                <div class="stat-value" id="cacheHits">0</div>
                                <div class="stat-label">缓存命中</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="cacheMisses">0</div>
                                <div class="stat-label">缓存未命中</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="hitRate">0%</div>
                                <div class="stat-label">命中率</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="cacheSize">0 MB</div>
                                <div class="stat-label">缓存大小</div>
                            </div>
                        </div>
                        <button onclick="updateStats()">刷新统计</button>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-header">📁 视频文件</div>
                    <div class="panel-content">
                        <div id="fileList" class="file-list">
                            <div style="text-align: center; color: #666; padding: 20px;">
                                请先连接服务器
                            </div>
                        </div>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-header">📝 实时日志</div>
                    <div class="panel-content">
                        <div id="logContainer" class="log-container"></div>
                        <button onclick="clearLogs()" style="margin-top: 10px;">清空日志</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let isConnected = false;
        let authHeader = '';
        let serverUrl = '';
        let basePath = '';
        let currentVideo = null;
        let statsInterval = null;
        let preloadInterval = null;
        let bufferConfig = { mode: 'auto', size: 10 }; // MB

        // DOM元素
        const elements = {
            serverUrl: document.getElementById('serverUrl'),
            username: document.getElementById('username'),
            password: document.getElementById('password'),
            basePath: document.getElementById('basePath'),
            preloadMode: document.getElementById('preloadMode'),
            bufferSize: document.getElementById('bufferSize'),
            connectBtn: document.getElementById('connectBtn'),
            refreshBtn: document.getElementById('refreshBtn'),
            statsBtn: document.getElementById('statsBtn'),
            videoPlayer: document.getElementById('videoPlayer'),
            progressContainer: document.getElementById('progressContainer'),
            progressBuffer: document.getElementById('progressBuffer'),
            progressSegments: document.getElementById('progressSegments'),
            progressBar: document.getElementById('progressBar'),
            bufferStatus: document.getElementById('bufferStatus'),
            networkSpeed: document.getElementById('networkSpeed'),
            currentTime: document.getElementById('currentTime'),
            duration: document.getElementById('duration'),
            videoStatus: document.getElementById('videoStatus'),
            downloadSpeed: document.getElementById('downloadSpeed'),
            fileList: document.getElementById('fileList'),
            logContainer: document.getElementById('logContainer'),
            cacheHits: document.getElementById('cacheHits'),
            cacheMisses: document.getElementById('cacheMisses'),
            hitRate: document.getElementById('hitRate'),
            cacheSize: document.getElementById('cacheSize')
        };

        // 日志记录
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.className = `log-entry ${type}`;
            div.textContent = `[${timestamp}] ${message}`;
            
            elements.logContainer.appendChild(div);
            elements.logContainer.scrollTop = elements.logContainer.scrollHeight;
            
            // 限制日志条数
            while (elements.logContainer.children.length > 100) {
                elements.logContainer.removeChild(elements.logContainer.firstChild);
            }
            
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // 清空日志
        function clearLogs() {
            elements.logContainer.innerHTML = '';
            addLog('日志已清空', 'info');
        }

        // 连接服务器
        async function connectToServer() {
            try {
                elements.connectBtn.disabled = true;
                addLog('正在连接服务器...', 'info');

                serverUrl = elements.serverUrl.value.trim();
                const username = elements.username.value.trim();
                const password = elements.password.value;
                basePath = elements.basePath.value.trim() || '/';

                if (!serverUrl || !username) {
                    throw new Error('请填写服务器地址和用户名');
                }

                authHeader = 'Basic ' + btoa(username + ':' + password);

                // 测试连接
                const response = await fetch(serverUrl + basePath, {
                    method: 'PROPFIND',
                    headers: {
                        'Authorization': authHeader,
                        'Content-Type': 'application/xml',
                        'Depth': '1'
                    },
                    body: `<?xml version="1.0" encoding="utf-8"?>
                        <d:propfind xmlns:d="DAV:">
                            <d:prop>
                                <d:displayname/>
                                <d:getcontentlength/>
                                <d:getcontenttype/>
                                <d:resourcetype/>
                            </d:prop>
                        </d:propfind>`
                });

                if (!response.ok) {
                    throw new Error(`连接失败: ${response.status} ${response.statusText}`);
                }

                const xmlText = await response.text();
                const files = parseWebDAVResponse(xmlText);

                isConnected = true;
                elements.refreshBtn.classList.remove('hidden');
                elements.statsBtn.classList.remove('hidden');

                addLog(`连接成功！找到 ${files.length} 个项目`, 'success');
                displayFiles(files);
                
                // 开始定期更新统计
                startStatsUpdate();

            } catch (error) {
                addLog(`连接失败: ${error.message}`, 'error');
            } finally {
                elements.connectBtn.disabled = false;
            }
        }

        // 解析WebDAV响应
        function parseWebDAVResponse(xmlText) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
            const responses = xmlDoc.querySelectorAll('response');
            const files = [];

            responses.forEach(response => {
                const href = response.querySelector('href')?.textContent;
                if (!href) return;

                const props = response.querySelector('prop');
                if (!props) return;

                const displayname = props.querySelector('displayname')?.textContent || '';
                const contentLength = props.querySelector('getcontentlength')?.textContent || '0';
                const contentType = props.querySelector('getcontenttype')?.textContent || '';
                const resourceType = props.querySelector('resourcetype');
                
                const isCollection = resourceType?.querySelector('collection') !== null;
                const isVideo = contentType.startsWith('video/') || 
                               displayname.match(/\.(mp4|avi|mov|mkv|webm|m4v)$/i);

                if (href === serverUrl + basePath || href.endsWith(basePath + '/')) {
                    return;
                }

                files.push({
                    name: displayname || decodeURIComponent(href.split('/').pop()),
                    href: href,
                    size: parseInt(contentLength) || 0,
                    type: contentType,
                    isDirectory: isCollection,
                    isVideo: isVideo && !isCollection
                });
            });

            return files.sort((a, b) => {
                if (a.isDirectory !== b.isDirectory) {
                    return a.isDirectory ? -1 : 1;
                }
                return a.name.localeCompare(b.name);
            });
        }

        // 显示文件列表
        function displayFiles(files) {
            elements.fileList.innerHTML = '';

            const videoFiles = files.filter(f => f.isVideo);
            if (videoFiles.length === 0) {
                elements.fileList.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">未找到视频文件</div>';
                return;
            }

            videoFiles.forEach(file => {
                const div = document.createElement('div');
                div.className = 'file-item video';
                div.innerHTML = `
                    <span>🎬</span>
                    <div style="flex: 1;">
                        <div>${file.name}</div>
                        <div style="font-size: 11px; color: #666;">${formatFileSize(file.size)}</div>
                    </div>
                `;
                
                div.onclick = () => playVideo(file);
                elements.fileList.appendChild(div);
            });
        }

        // 更新缓冲配置
        function updateBufferConfig() {
            bufferConfig.mode = elements.preloadMode.value;
            bufferConfig.size = parseInt(elements.bufferSize.value);
            
            // 更新视频preload属性
            elements.videoPlayer.preload = bufferConfig.mode;
            
            addLog(`缓冲配置已更新: ${bufferConfig.mode}, ${bufferConfig.size}MB`, 'info');
        }

        // 智能预缓冲状态
        let prebufferState = {
            isActive: false,
            lastPosition: 0,
            speed: 0, // bytes per second
            queue: [],
            downloading: new Set(),
            cachedSegments: new Map(), // 缓存的分段信息
            downloadStats: {
                totalBytes: 0,
                totalTime: 0,
                recentSpeeds: []
            }
        };

        // 更新缓冲段可视化
        function updateBufferVisualization() {
            if (!currentVideo) return;
            
            const segmentsContainer = elements.progressSegments;
            segmentsContainer.innerHTML = '';
            
            // 显示已缓存的分段
            for (const [key, segment] of prebufferState.cachedSegments) {
                const startPercent = (segment.start / currentVideo.size) * 100;
                const endPercent = (segment.end / currentVideo.size) * 100;
                const width = Math.max(0.1, endPercent - startPercent); // 最小0.1%宽度
                
                const segmentDiv = document.createElement('div');
                segmentDiv.className = 'progress-segment';
                segmentDiv.style.left = startPercent + '%';
                segmentDiv.style.width = width + '%';
                segmentDiv.title = `缓存分段: ${Math.floor(segment.start / 1024 / 1024)}MB - ${Math.floor(segment.end / 1024 / 1024)}MB`;
                
                segmentsContainer.appendChild(segmentDiv);
            }
            
            // 显示正在下载的分段
            for (const key of prebufferState.downloading) {
                const [start, end] = key.split('-').map(Number);
                const startPercent = (start / currentVideo.size) * 100;
                const endPercent = (end / currentVideo.size) * 100;
                const width = Math.max(0.1, endPercent - startPercent);
                
                const downloadingDiv = document.createElement('div');
                downloadingDiv.className = 'progress-downloading';
                downloadingDiv.style.left = startPercent + '%';
                downloadingDiv.style.width = width + '%';
                downloadingDiv.title = `下载中: ${Math.floor(start / 1024 / 1024)}MB - ${Math.floor(end / 1024 / 1024)}MB`;
                
                segmentsContainer.appendChild(downloadingDiv);
            }
        }

        // 更新网速显示
        function updateNetworkSpeed() {
            const stats = prebufferState.downloadStats;
            if (stats.recentSpeeds.length > 0) {
                const avgSpeed = stats.recentSpeeds.reduce((a, b) => a + b, 0) / stats.recentSpeeds.length;
                const speedText = avgSpeed > 1024 ? 
                    `${(avgSpeed / 1024).toFixed(1)} MB/s` : 
                    `${avgSpeed.toFixed(0)} KB/s`;
                
                elements.networkSpeed.textContent = speedText;
                elements.downloadSpeed.textContent = speedText;
            }
        }

        // 更新缓冲状态
        function updateBufferStatus() {
            if (!currentVideo) return;
            
            const video = elements.videoPlayer;
            const buffered = video.buffered;
            
            if (buffered.length > 0 && video.duration) {
                let bufferedDuration = 0;
                for (let i = 0; i < buffered.length; i++) {
                    bufferedDuration += buffered.end(i) - buffered.start(i);
                }
                
                const bufferPercent = (bufferedDuration / video.duration * 100).toFixed(1);
                elements.bufferStatus.textContent = bufferPercent + '%';
                
                // 更新浏览器原生缓冲条
                if (buffered.length > 0) {
                    const bufferProgress = (buffered.end(buffered.length - 1) / video.duration) * 100;
                    elements.progressBuffer.style.width = bufferProgress + '%';
                }
            }
        }

        // 计算播放速度
        function calculatePlaybackSpeed() {
            const video = elements.videoPlayer;
            if (!video.duration || !video.currentTime) return 0;
            
            const now = Date.now();
            const currentPos = video.currentTime;
            const timeDelta = (now - (prebufferState.lastCheck || now)) / 1000;
            const posDelta = currentPos - prebufferState.lastPosition;
            
            if (timeDelta > 0) {
                const bytesPerSecond = (posDelta / video.duration) * currentVideo.size / timeDelta;
                prebufferState.speed = Math.max(0, bytesPerSecond);
            }
            
            prebufferState.lastPosition = currentPos;
            prebufferState.lastCheck = now;
            
            return prebufferState.speed;
        }

        // 智能预缓冲函数
        async function backgroundPrebuffer(videoUrl, currentTime, duration) {
            if (bufferConfig.mode !== 'auto' || !currentVideo || prebufferState.isActive) return;
            
            prebufferState.isActive = true;
            
            try {
                const video = elements.videoPlayer;
                const isPaused = video.paused;
                const playbackSpeed = calculatePlaybackSpeed();
                
                // 计算当前播放位置的字节位置
                const currentByte = Math.floor((currentTime / duration) * currentVideo.size);
                const segmentSize = 2 * 1024 * 1024; // 2MB
                
                // 确定预缓冲策略
                let prebufferBytes = bufferConfig.size * 1024 * 1024; // 基础缓冲大小
                
                if (isPaused) {
                    // 暂停时，更积极地预缓冲
                    prebufferBytes = Math.min(prebufferBytes * 2, 50 * 1024 * 1024); // 最多50MB
                    addLog('视频暂停，启动积极预缓冲', 'info');
                } else if (playbackSpeed > 0) {
                    // 根据播放速度调整预缓冲大小
                    const predictedNeedBytes = playbackSpeed * 30; // 预测30秒需要的数据
                    prebufferBytes = Math.max(prebufferBytes, predictedNeedBytes);
                }
                
                // 分段下载
                const segments = [];
                let nextByte = currentByte;
                const maxByte = Math.min(currentByte + prebufferBytes, currentVideo.size - 1);
                
                while (nextByte < maxByte) {
                    const segmentEnd = Math.min(nextByte + segmentSize - 1, maxByte);
                    const segmentKey = `${nextByte}-${segmentEnd}`;
                    
                    // 避免重复下载
                    if (!prebufferState.downloading.has(segmentKey)) {
                        segments.push({ start: nextByte, end: segmentEnd, key: segmentKey });
                        prebufferState.downloading.add(segmentKey);
                    }
                    
                    nextByte = segmentEnd + 1;
                }
                
                if (segments.length === 0) {
                    prebufferState.isActive = false;
                    return;
                }
                
                addLog(`启动预缓冲: ${segments.length} 个分段，总计 ${Math.floor(prebufferBytes / 1024 / 1024)}MB`, 'info');
                
                // 并发下载多个分段（最多3个并发）
                const concurrency = Math.min(3, segments.length);
                const promises = [];
                
                for (let i = 0; i < concurrency; i++) {
                    promises.push(downloadSegmentQueue(videoUrl, segments, i));
                }
                
                await Promise.all(promises);
                
            } catch (error) {
                addLog(`预缓冲出错: ${error.message}`, 'warning');
            } finally {
                prebufferState.isActive = false;
            }
        }

        // 分段队列下载器
        async function downloadSegmentQueue(videoUrl, segments, workerId) {
            while (segments.length > 0) {
                const segment = segments.shift();
                if (!segment) break;
                
                try {
                    const startTime = Date.now();
                    addLog(`Worker${workerId}: 下载分段 ${Math.floor(segment.start / 1024 / 1024)}MB-${Math.floor(segment.end / 1024 / 1024)}MB`, 'info');
                    
                    const response = await fetch(videoUrl, {
                        headers: {
                            'Range': `bytes=${segment.start}-${segment.end}`
                        }
                    });
                    
                    if (response.ok) {
                        const duration = Date.now() - startTime;
                        const size = parseInt(response.headers.get('content-length') || '0');
                        const speedKBps = size > 0 ? (size / duration * 1000 / 1024) : 0;
                        
                        // 记录分段缓存信息
                        prebufferState.cachedSegments.set(segment.key, {
                            start: segment.start,
                            end: segment.end,
                            size: size,
                            timestamp: Date.now()
                        });
                        
                        // 更新下载统计
                        prebufferState.downloadStats.totalBytes += size;
                        prebufferState.downloadStats.totalTime += duration;
                        prebufferState.downloadStats.recentSpeeds.push(speedKBps);
                        
                        // 保持最近10次的速度记录
                        if (prebufferState.downloadStats.recentSpeeds.length > 10) {
                            prebufferState.downloadStats.recentSpeeds.shift();
                        }
                        
                        addLog(`Worker${workerId}: 分段下载完成 ${Math.floor(size / 1024)}KB, 速度: ${speedKBps.toFixed(1)}KB/s`, 'success');
                        
                        // 读取响应体以确保完整下载
                        await response.arrayBuffer();
                        
                        // 更新可视化
                        updateBufferVisualization();
                        updateNetworkSpeed();
                    } else {
                        addLog(`Worker${workerId}: 分段下载失败 ${response.status}`, 'warning');
                    }
                } catch (error) {
                    addLog(`Worker${workerId}: 分段下载错误 ${error.message}`, 'warning');
                } finally {
                    prebufferState.downloading.delete(segment.key);
                }
            }
        }

        // 播放视频
        async function playVideo(file) {
            try {
                addLog(`开始播放: ${file.name}`, 'info');
                
                // 移除之前的active状态
                document.querySelectorAll('.file-item.active').forEach(item => {
                    item.classList.remove('active');
                });
                
                // 添加当前active状态
                event.currentTarget.classList.add('active');
                
                currentVideo = file;
                
                // 构建视频URL
                let videoPath = file.href;
                if (videoPath.startsWith('/webdav/')) {
                    videoPath = videoPath.substring('/webdav'.length);
                }
                
                const videoUrl = serverUrl + videoPath;
                addLog(`视频URL: ${videoUrl}`, 'info');
                
                // 更新缓冲配置
                updateBufferConfig();
                
                // 设置视频源
                elements.videoPlayer.src = videoUrl;
                elements.videoStatus.textContent = `加载中: ${file.name}`;
                
                // 重置进度条和缓冲可视化
                elements.progressBar.style.width = '0%';
                elements.progressBuffer.style.width = '0%';
                elements.progressSegments.innerHTML = '';
                elements.bufferStatus.textContent = '0%';
                elements.networkSpeed.textContent = '0 KB/s';
                
                // 重置预缓冲状态
                prebufferState.cachedSegments.clear();
                prebufferState.downloading.clear();
                prebufferState.downloadStats = {
                    totalBytes: 0,
                    totalTime: 0,
                    recentSpeeds: []
                };
                
                // 清除之前的预缓冲定时器
                if (preloadInterval) {
                    clearInterval(preloadInterval);
                }
                
                // 如果是自动模式，设置预缓冲定时器
                if (bufferConfig.mode === 'auto') {
                    preloadInterval = setInterval(() => {
                        const duration = elements.videoPlayer.duration;
                        const currentTime = elements.videoPlayer.currentTime;
                        
                        if (duration && currentTime !== undefined) {
                            backgroundPrebuffer(videoUrl, currentTime, duration);
                        }
                    }, 5000); // 每5秒检查一次预缓冲
                }
                
            } catch (error) {
                addLog(`播放失败: ${error.message}`, 'error');
            }
        }

        // 更新统计信息
        async function updateStats() {
            try {
                const response = await fetch(serverUrl + '/stats');
                const stats = await response.json();
                
                elements.cacheHits.textContent = stats.hits || 0;
                elements.cacheMisses.textContent = stats.misses || 0;
                elements.hitRate.textContent = stats.hitRate + '%' || '0%';
                elements.cacheSize.textContent = stats.cacheSize || '0 MB';
                
            } catch (error) {
                console.error('获取统计失败:', error);
            }
        }

        // 开始定期更新统计
        function startStatsUpdate() {
            if (statsInterval) clearInterval(statsInterval);
            statsInterval = setInterval(updateStats, 2000);
            updateStats();
        }

        // 格式化文件大小
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // 格式化时间
        function formatTime(seconds) {
            if (!seconds || isNaN(seconds)) return '00:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // 视频事件监听器
        elements.videoPlayer.addEventListener('loadedmetadata', () => {
            elements.duration.textContent = formatTime(elements.videoPlayer.duration);
            elements.videoStatus.textContent = `已就绪: ${currentVideo?.name || ''}`;
            addLog('视频元数据已加载', 'success');
        });

        elements.videoPlayer.addEventListener('timeupdate', () => {
            const current = elements.videoPlayer.currentTime;
            const duration = elements.videoPlayer.duration;
            
            elements.currentTime.textContent = formatTime(current);
            
            if (duration > 0) {
                const progress = (current / duration) * 100;
                elements.progressBar.style.width = progress + '%';
            }
        });

        elements.videoPlayer.addEventListener('progress', () => {
            updateBufferStatus();
        });

        elements.videoPlayer.addEventListener('waiting', () => {
            elements.videoStatus.innerHTML = '缓冲中... <span class="loading"></span>';
            addLog('视频缓冲中...', 'warning');
        });

        elements.videoPlayer.addEventListener('playing', () => {
            elements.videoStatus.textContent = `播放中: ${currentVideo?.name || ''}`;
            addLog('视频开始播放', 'success');
        });

        elements.videoPlayer.addEventListener('error', (e) => {
            const error = elements.videoPlayer.error;
            elements.videoStatus.textContent = '播放错误';
            addLog(`播放错误: ${error?.message || '未知错误'}`, 'error');
        });

        // 进度条点击跳转
        elements.progressContainer.addEventListener('click', (e) => {
            const rect = elements.progressContainer.getBoundingClientRect();
            const percent = (e.clientX - rect.left) / rect.width;
            const duration = elements.videoPlayer.duration;
            
            if (duration > 0) {
                const seekTime = percent * duration;
                elements.videoPlayer.currentTime = seekTime;
                addLog(`跳转到: ${formatTime(seekTime)}`, 'info');
            }
        });

        // 事件绑定
        elements.connectBtn.addEventListener('click', connectToServer);
        elements.refreshBtn.addEventListener('click', () => {
            if (isConnected) connectToServer();
        });
        
        // 预加载设置事件监听
        elements.preloadMode.addEventListener('change', updateBufferConfig);
        elements.bufferSize.addEventListener('change', updateBufferConfig);

        // 初始化
        addLog('增强版WebDAV播放器已启动', 'info');
        addLog('支持Range请求、智能缓存、实时监控', 'info');
    </script>
</body>
</html>